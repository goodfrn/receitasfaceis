{{ define "main" }}

{{ $config := .Site.Data.config }}
{{ $homepage := $config.homepage }}

<!-- Hero animé (conservé tel quel car spécifique) -->
{{ partial "hero.html" . }}

<!-- SECTION MIGRÉE : Dernières recettes -->
<section class="section">
  <div class="container">
    
    <!-- 🏷️ Titre avec classe section__title -->
    <h2 class="section__title">
      {{ $homepage.latest_recipes.title }}
    </h2>
    
    <!-- Description -->
    <p class="text-base text-center mb-8 max-w-2xl mx-auto" style="color: var(--color-text-secondary);">
      {{ $homepage.latest_recipes.description }}
    </p>

    <!-- Grille recettes avec CARTES PREMIUM -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {{ range first 6 (where .Site.RegularPages "Section" "recipes") }}
        
        <!-- 🏆 CARTE PREMIUM STYLÉE -->
        <a href="{{ .RelPermalink }}" class="group block bg-white overflow-hidden hover:shadow-xl transition-shadow duration-300 rounded-lg">
          
          <!-- Image optimisée -->
          <div class="relative overflow-hidden aspect-[4/3]">
            {{ with .Params.image }}
              {{ $img := resources.Get (printf "images/%s" .) }}
              {{ if $img }}
                {{ $webp := $img.Fill "600x400 q80 webp" }}
                {{ $fallback := $img.Fill "600x400 q85" }}
                
                <picture>
                  <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
                  <img src="{{ $fallback.RelPermalink }}" 
                       alt="{{ $.Title }}" 
                       class="w-full h-full object-cover"
                       loading="lazy"
                       width="600" 
                       height="400">
                </picture>
              {{ else }}
                <img src="/{{ . }}" 
                     alt="{{ $.Title }}" 
                     class="w-full h-full object-cover"
                     loading="lazy">
              {{ end }}
            {{ end }}
            
            <!-- Badge catégorie -->
            {{ with index .Params.categories 0 }}
              <div class="absolute top-4 left-4 px-3 py-1.5 bg-white/90 rounded-full shadow-sm">
                <span class="text-xs font-semibold tracking-wide uppercase" style="color: var(--primary);">
                  {{ . }}
                </span>
              </div>
            {{ end }}
          </div>
          
          <!-- Contenu premium -->
          <div class="p-6 space-y-4">
            
            <!-- Titre élégant -->
            <h3 class="font-serif text-xl leading-tight font-medium" 
                style="color: var(--color-text); font-family: 'Times New Roman', serif;">
              {{ .Title }}
            </h3>
            
            <!-- Métriques sophistiquées -->
            <div class="flex items-center justify-between pt-2 border-t border-gray-100">
              
              <!-- Temps -->
              {{ with .Params.totalTime }}
                <div class="flex items-center space-x-1.5">
                  <div class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
                  </div>
                  <span class="text-sm font-medium text-gray-700">
                    {{ . | replaceRE "^PT(\\d+)M$" "$1 min" | replaceRE "^PT(\\d+)H$" "$1h" | replaceRE "^PT(\\d+)H(\\d+)M$" "$1h $2min" }}
                  </span>
                </div>
              {{ end }}
              
              <!-- Portions -->
              {{ with .Params.recipeYield }}
                <div class="flex items-center space-x-1.5">
                  <div class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
                  </div>
                  <span class="text-sm font-medium text-gray-700">
                    {{ . }}
                  </span>
                </div>
              {{ end }}
              
              <!-- Calories -->
              {{ with .Params.nutrition.calories }}
                <div class="flex items-center space-x-1.5">
                  <div class="w-4 h-4 rounded-full bg-orange-100 flex items-center justify-center">
                    <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                  </div>
                  <span class="text-sm font-medium text-gray-700">
                    {{ . }} cal
                  </span>
                </div>
              {{ end }}
            </div>
            
            <!-- Tags premium -->
            {{ if .Params.tags }}
              <div class="flex flex-wrap gap-2 pt-3">
                {{ range first 3 .Params.tags }}
                  <span class="px-2.5 py-1 bg-gray-50 rounded-full">
                    <span class="text-xs font-medium text-gray-600">{{ . }}</span>
                  </span>
                {{ end }}
              </div>
            {{ end }}
            
            <!-- Footer editorial -->
            <div class="flex justify-end pt-4 border-t border-gray-50">
              <time class="text-xs text-gray-400 font-medium" datetime="{{ .Date.Format "2006-01-02" }}">
                {{ .Date.Format "Jan 2, 2006" }}
              </time>
            </div>
          </div>
          
        </a>

      {{ end }}
    </div>
  </div>
</section>

<!-- SECTION MIGRÉE : Recettes populaires -->
<section class="section">
  <div class="container">
    
    <!-- 🏷️ Titre avec classe section__title -->
    <h2 class="section__title">
      {{ $homepage.popular_recipes.title }}
    </h2>
    
    <!-- Grille recettes avec CARTES PREMIUM -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {{ $all := where .Site.RegularPages "Section" "recipes" }}
      {{ $count := len $all }}
      {{ if gt $count 0 }}
        {{ $week := div now.Unix 604800 }}
        {{ $offset := mod $week $count }}
        {{ $limit := 6 }}
        {{ if lt $count 6 }}{{ $limit = $count }}{{ end }}

        {{ range $i := seq 0 (sub $limit 1) }}
          {{ $idx := mod (add $offset $i) $count }}
          {{ $item := index $all $idx }}
          
          <!-- 🏆 CARTE PREMIUM STYLÉE -->
          <a href="{{ $item.RelPermalink }}" class="group block bg-white overflow-hidden hover:shadow-xl transition-shadow duration-300 rounded-lg">
            
            <!-- Image optimisée -->
            <div class="relative overflow-hidden aspect-[4/3]">
              {{ with $item.Params.image }}
                {{ $img := resources.Get (printf "images/%s" .) }}
                {{ if $img }}
                  {{ $webp := $img.Fill "600x400 q80 webp" }}
                  {{ $fallback := $img.Fill "600x400 q85" }}
                  
                  <picture>
                    <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
                    <img src="{{ $fallback.RelPermalink }}" 
                         alt="{{ $item.Title }}" 
                         class="w-full h-full object-cover"
                         loading="lazy"
                         width="600" 
                         height="400">
                  </picture>
                {{ else }}
                  <img src="/{{ . }}" 
                       alt="{{ $item.Title }}" 
                       class="w-full h-full object-cover"
                       loading="lazy">
                {{ end }}
              {{ end }}
              
              <!-- Badge catégorie -->
              {{ with index $item.Params.categories 0 }}
                <div class="absolute top-4 left-4 px-3 py-1.5 bg-white/90 rounded-full shadow-sm">
                  <span class="text-xs font-semibold tracking-wide uppercase" style="color: var(--primary);">
                    {{ . }}
                  </span>
                </div>
              {{ end }}
            </div>
            
            <!-- Contenu premium -->
            <div class="p-6 space-y-4">
              
              <!-- Titre élégant -->
              <h3 class="font-serif text-xl leading-tight font-medium" 
                  style="color: var(--color-text); font-family: 'Times New Roman', serif;">
                {{ $item.Title }}
              </h3>
              
              <!-- Métriques sophistiquées -->
              <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                
                <!-- Temps -->
                {{ with $item.Params.totalTime }}
                  <div class="flex items-center space-x-1.5">
                    <div class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-700">
                      {{ . | replaceRE "^PT(\\d+)M$" "$1 min" | replaceRE "^PT(\\d+)H$" "$1h" | replaceRE "^PT(\\d+)H(\\d+)M$" "$1h $2min" }}
                    </span>
                  </div>
                {{ end }}
                
                <!-- Portions -->
                {{ with $item.Params.recipeYield }}
                  <div class="flex items-center space-x-1.5">
                    <div class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-700">
                      {{ . }}
                    </span>
                  </div>
                {{ end }}
                
                <!-- Calories -->
                {{ with $item.Params.nutrition.calories }}
                  <div class="flex items-center space-x-1.5">
                    <div class="w-4 h-4 rounded-full bg-orange-100 flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-700">
                      {{ . }} cal
                    </span>
                  </div>
                {{ end }}
              </div>
              
              <!-- Tags premium -->
              {{ if $item.Params.tags }}
                <div class="flex flex-wrap gap-2 pt-3">
                  {{ range first 3 $item.Params.tags }}
                    <span class="px-2.5 py-1 bg-gray-50 rounded-full">
                      <span class="text-xs font-medium text-gray-600">{{ . }}</span>
                    </span>
                  {{ end }}
                </div>
              {{ end }}
              
              <!-- Footer editorial -->
              <div class="flex justify-end pt-4 border-t border-gray-50">
                <time class="text-xs text-gray-400 font-medium" datetime="{{ $item.Date.Format "2006-01-02" }}">
                  {{ $item.Date.Format "Jan 2, 2006" }}
                </time>
              </div>
            </div>
            
          </a>
        {{ end }}
      {{ else }}
        <p class="text-center col-span-full" style="color: var(--color-text-secondary);">
          {{ $homepage.popular_recipes.empty_message }}
        </p>
      {{ end }}
    </div>
  </div>
</section>

<!-- SECTION MIGRÉE : Explorer par catégorie -->
<section class="section">
  <div class="container">
    
    <!-- 🏷️ Titre avec classe section__title -->
    <h2 class="section__title">
      {{ $homepage.categories_section.title }}
    </h2>
    
    <!-- Grille catégories avec CARDS MIGRÉES -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 justify-center">
      {{ range sort .Site.Taxonomies.categories "Count" "desc" }}
        {{/* 🎯 LOGIQUE IDENTIQUE aux autres templates */}}
        {{ $slug := .Page.Title | lower | urlize }}
        {{ $displayName := .Page.Title }}
        
        {{/* Chercher dans la config s'il y a un nom personnalisé */}}
        {{ $config := $.Site.Data.config }}
        {{ range $config.categories_system.categories_config.categories_list }}
          {{ if eq .slug $slug }}
            {{ $displayName = .name }}
          {{ end }}
        {{ end }}
        
        <a href="{{ .Page.RelPermalink }}" class="card--compact card flex items-center justify-center text-center text-base font-semibold min-h-[96px] hover:scale-105 transform transition duration-300" style="color: var(--color-text); font-family: var(--font-serif);">
          {{ $displayName }}  {{/* ← MAINTENANT AFFICHE "Apéritifs Gourmands" */}}
        </a>
      {{ end }}
    </div>
  </div>
</section>

<!-- SECTION MIGRÉE : Newsletter -->
<section class="section">
  <div class="container">
    
    <!-- 🏷️ Titre avec classe section__title -->
    <h2 class="section__title">
      {{ $homepage.newsletter.title }}
    </h2>
    
    <!-- Description -->
    <p class="text-center max-w-xl mx-auto mb-8 text-base" style="color: var(--color-text-secondary);">
      {{ $homepage.newsletter.description }}
    </p>
    
    <!-- Formulaire newsletter avec BOUTON MIGRÉ -->
    <form action="{{ $homepage.newsletter.form_action }}" method="POST" class="max-w-lg mx-auto flex flex-col sm:flex-row sm:items-center gap-4">
      <label for="newsletter-email" class="sr-only">Adresse email</label>
      <input id="newsletter-email" type="email" name="email" required placeholder="{{ $homepage.newsletter.email_placeholder }}" class="w-full sm:flex-grow px-4 py-3 border rounded-lg focus:outline-none focus:ring-2" style="border-color: var(--color-text-muted); color: var(--color-text);">
      <!-- BOUTON NEWSLETTER MIGRÉ -->
      <button type="submit" class="btn btn--primary btn--lg">
        {{ $homepage.newsletter.button_text }}
      </button>
    </form>
  </div>
</section>

{{ end }}
